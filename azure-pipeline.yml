trigger:
  branches:
    include:
      - master

pool:
  name: 'default'
  
variables:
  buildConfiguration: 'Release'
  dotnetVersion: '10.x'
  webAppDev: 'cleanarchdemo.dev'
  webAppProd: 'cleanarchdemo.prod'
  azureServiceConnection: 'azure-service-connection'

stages:
  - stage: Build
    displayName: 'Build'
    jobs:
      - job: BuildJob
        displayName: 'Build and Publish'
        steps:
          
          - task: UseDotNet@2
            displayName: 'Install .NET $(dotnetVersion)'
            inputs:
              version: $(dotnetVersion)
              packageType: 'sdk'
              includePreviewVersions: true
              
          - task: DotNetCoreCLI@2
            displayName: 'Restore packages'
            inputs:
              command: 'restore'
              projects: '**/*.sln'
              
          - task: DotNetCoreCLI@2
            displayName: 'Build solution'
            inputs:
              command: 'build'
              projects: '**/*.sln'
              arguments: '--configuration $(buildConfiguration) --no-restore'
            
          - task : DotNetCoreCLI@2
            displayName: 'Publish API'
            inputs:
              command: 'publish'
              projects: 'src/Devops.API/*.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore --output $(Build.ArtifactStagingDirectory)/api'
              zipAfterPublish: true
          
          - task: PublishPipelineArtifact@1
            displayName: 'Upload deployment package'
            inputs:
              targetPath: '$(Build.ArtifactStagingDirectory)/api'
              artifactName: 'drop'
              publishLocation: 'pipeline'
          - task: PublishPipelineArtifact@1
            displayName: 'Upload source for testing'
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)'
              artifactName: 'built-source'
              publishLocation: 'pipeline'
  - stage: Test
    displayName: 'Test'
    dependsOn: Build
    jobs:
      - job: TestJob
        displayName: 'Run Tests'
        steps:
          
          - task: UseDotNet@2
            displayName: 'Install .NET $(dotnetVersion)'
            inputs:
              version: $(dotnetVersion)
              packageType: 'sdk'
              includePreviewVersions: true
          
          - task: DownloadPipelineArtifact@2
            displayName: 'Download built source'
            inputs:
              artifactName: 'built-source'
              targetPath: '$(System.DefaultWorkingDirectory)'
          
          - task: DotNetCoreCLI@2
            displayName: 'Run tests'
            inputs:
              command: 'test'
              projects: 'tests/**/*tests.csproj'
              arguments: >-
                --configuration $(buildConfiguration)
                --no-build
                --collect:"XPlat Code Coverage"
                --results-directory $(Agent.TempDirectory)/TestResults
              publishTestResults: true
          
          - task: PublishCodeCoverageResults@2
            displayName: 'Publis coverage report'
            condition: succeededOrFailed()
            inputs:
              summaryFileLocation: '$(Agent.TempDirectory)/TestResults/**/coverage.codertura.xml'
              failIfCoverageEmoty: false
        
  - stage: DeployDev
    displayName: 'Deploy to dev'
    dependsOn: Test
    condition: succeeded()
    variables:
      - group: vg-dev
    jobs:
      - deployment: DeployDevJob
        displayName: 'Deploy to Dev App Service'
        environment: 'Dev'
        strategy:
          runOnce:
            deploy:
              steps:
                
                - task: UseDotNet@2
                  displayName: 'Install .NET $(dotnetVersion)'
                  inputs:
                    version: $(dotnetVersion)
                    packageType: 'sdk'
                    includePreviewVersions: true
                
                - task: DownloadPipelineArtifact@2
                  displayName: 'Download deployment package'
                  inputs:
                    artifactName: 'drop'
                    targetPath: '$(System.DefaultWorkingDirectory)/deploy'
                
                - task: AzureWebApp@1
                  displayName: 'Deploy to cleanArchdemo.dev'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: 'webapp'
                    appName: '$(webAppDev)'
                    package: '$(System.DefaultWorkingDirectory)/deploy/*.zip'
                    deploymentMethod: 'auto'
                    appSettings: >-
                      -ConnectionStrings__Default "$(ConnectionString)"
      
  - stage: DeployProd
    displayName: "Deploy to Prod"
    dependsOn: DeployDev
    condition: succeeded()
    variables:
      - group: vg-prod
    jobs:
      - deployment: DeployProdJob
        displayName: 'Deploy to prod App Service'
        environment: 'Prod'
        strategy:
          runOnce:
            deploy:
              steps:
                
                - task: UseDotNet@2
                  displayName: 'Install .NET $(dotnetVersion)'
                  inputs:
                    version: $(dotnetVersion)
                    packageType: 'sdk'
                    includePreviewVersions: true
                
                - task: DownloadPipelineArtifact@2
                  displayName: 'Download deployment package'
                  inputs:
                    artifactName: 'drop'
                    targetPath: '$(System.DefaultWorkingDirectory)/deploy'
                    
                - task: AzureWebApp@1
                  displayName: 'Deploy to cleanarchDemo-prod'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: 'webApp'
                    appName: '$(webAppProd)'
                    package: '$(System.DefaultWorkingDirectory)/deploy/*.zip'
                    deploymentMethod: 'auto'
                    appSettings: >-
                      -ConnectionStrings__Default "$(ConnectionString)"